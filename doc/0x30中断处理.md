中断
===========


中断的分类
---------------

中断可以分为外部中断和内部中断. 外部中断来源于某个硬件, 因此也被称为硬件中断(例如网卡抽到数据). 为了使外部的硬件能够通知CPU产生中断, CPU提供了两根信号线, 分别是INTR(INTePpupt)和NMI(Non Maskable Interrupt). 从两者的名字就可以知道, 一个用于普通的硬件中断, 一个用于灾难性硬件中断(例如电源掉电, 内存读写错误等).

内部中断可以分为软中断和异常. 软中断和硬件中断相对, 指的是软件主动发起的中断. 例如汇编中的int指令即可发起中断. 异常是CPU执行错误中产生的错误引起的. 例如除数为零.

异常可以细分为三类, 即Fault, Trap和Abort. 其中Fault表示该异常状态可以被修复. 发生此异常时, CPU将状态恢复到出现异常之前的状态, 并调用相应的中断程序, 之后继续执行原本的代码. 通常该异常会被中断程序修复, 典型的例子就是缺页异常. Trap通常用于调试中, 程序执行到发出Trap异常的地方就会进入中断处理程序, 从而能够提供一个调试程序的接口. Abort表示程序出现严重的错误, 因此只能关闭该程序以保护整个系统不受影响.

为了统一的管理各种类型的中断, 每种中断信号都有一个中断号. 异常和不可屏蔽中断的中断号由CPU提供, 外部设备的可屏蔽中断的中断号由中断代理提供(例如8259A), 软中断的中断号由程序提供.


中断描述符表
---------------

中断描述符(Interrupt Descriptor Table, IDT)记录了中断的详细信息, CPU在收到中断请求后, 根据请求号在IDT中查询具体的中断程序.





中断描述符表寄存器
---------------------

中断描述符表寄存器(Interrupt Descriptor Table Register, IDTR)一共有48bit, 其中0~15bit表示界限, 即`中断描述符的大小-1`, 16~47bit表示中断描述符表的基址.

由于每个中断描述符需要8字节, 而16bit最多表示64KB空间, 因此最多可以存储 64K / 8 = 8K个中断描述符.



中断执行过程
------------------

1. 如果发生特权转移, 则需要将低特权等级的栈选择子ss和栈指针esp入栈
2. 压入标志寄存器eflags
3. 依次压入返回地址的cs和eip
4. 如果中断具有错误码, 则压入错误码. 如果无错误码, 则不进行任何操作.

